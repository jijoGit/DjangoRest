
import csv
import os
import django

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'biowebRest.settings')
django.setup()

from collections import defaultdict
from bioScienceApp.models import *

print('Executing populateDB script **********************')

''' 
A CSV file of protein sequences. Each record consists of two columns. 
The first column is the Protein ID and the second column is the protein sequence in single letter code. 
Not all proteins in the data set have sequences

protein ID
Protein Sequence

'''
data_sequences_file = '.\\csv\\assignment_data_sequences.csv'
assignment_data_set = '.\\csv\\assignment_data_set.csv'
pfam_descriptions = '.\\csv\\pfam_descriptions.csv'

taxonomys = defaultdict(list)
proteins = defaultdict(list)
taxonomyProteinLink = defaultdict(list)
pfams = defaultdict(dict)
proteinDomainLink = defaultdict(list)


# protein_organism = defaultdict(list)

# junction_protein_org = defaultdict(list)
# junction_pfam_domain = defaultdict(list)

def add_proteins(protein_id,protein_length,container):

    # adding 'length' to proteins dict. 
    if protein_id in container:
        #since the protein is already there, lenght has to be appended to.
        
        if (len(container[protein_id]) == 1):
            container[protein_id].append(protein_length)
        # else: same information not needed to add
    else:
        container[protein_id] = [protein_length]
        
    return container



#add row in format : {'568076': ['E', 'Metarhizium', 'robertsii']})
def add_taxonomys(taxa_id, clade, genus_species, container):

    # split_list[1] is Organism TAXA ID
    if not taxa_id in container:
        genus, species = genus_species.split(' ',1)
        container[taxa_id] = [clade, genus, species]
    else: #not likely 
        #is the Organism Clade Idenitifer and Genus Species different
        if not container[taxa_id][0] == clade:
            print( container[taxa_id] + ' clade is different ')
        elif not container[taxa_id][1] in genus_species:
            print( container[taxa_id] + ' specis is different ' + genus_species)

    return container

def add_domains_id_desc(domain_id, desc, container):
    if not domain_id in container:
        container[domain_id] = [desc]
    

    return container


def add_protein_organisms(protein_id,taxa_id, start, end, container):
    '''
    junction table to connect protein and organism as 
    "organisms are made of one or more cells. Each cell contains DNA and proteins. 
    Each protein has a biochemical function". 
    
    for case: Organisms can have more proteins 
    '''

    if protein_id in container:
        if not taxa_id in container[protein_id]:
            container[protein_id].append( [start, end, taxa_id])
        #else do not do anything ignore 
    
    #otherwise just add it as first entry
    else:
        container[protein_id] = [start, end, taxa_id]

    return(container)


def add_domains(domain_id, desc, protein_id, container):
    if not domain_id in container:
        container[domain_id] = [desc, protein_id]
    
    return container


with open(assignment_data_set) as csv_file:
    csv_reader_assignment_data = csv.reader(csv_file, delimiter='\n')
    for row in csv_reader_assignment_data:
        split_list = row[0].split(',')

        proteinId = split_list[0]
        taxaId = split_list[1]
        clade=split_list[2]
        genusSpecies= split_list[3]

        domainDesc=split_list[4]
        domainId=split_list[5]
        start=split_list[6]
        end=split_list[7]
        proteinLength=split_list[-1]

                
        #create protein dict 
        proteins = add_proteins(protein_id=proteinId,protein_length=proteinLength, container = proteins)

        # create organisms dict
        organisms = add_taxonomys(taxa_id = taxaId, genus_species= genusSpecies, clade=clade, container=taxonomys)

        # taxonomyProteinLink = add_taxonomyProteinLink()
    
        #table to connect protein and organisms
        protein_organisms = add_protein_organisms(protein_id = proteinId, taxa_id = taxaId, start=split_list[6], end=split_list[7], container = protein_organism)
        
        # create domain dict
        domains = add_domains(domain_id=domainId, desc=domainDesc, protein_id = proteinId, container=domains)        
        

print('Length:')
print('organisms:', len(organisms))
print('proteins:', len(proteins))
print('domains:',len(domains))
print('protein_Organism:', len(protein_organism))


def delete_all_tables():
    Domain.objects.all().delete()
    ProteinOrganismLink.objects.all().delete()
    Protein.objects.all().delete()
    Organism.objects.all().delete()
    Pfam.objects.all().delete()
     


organism_rows = {}
protein_rows = {}
domain_rows = {}
pfam_rows={}
    
# print('protein created')

def populate_organisms_table(organism_rows, organisms):
    for organism_id in organisms:
        content_list = organisms[organism_id]
        if len(content_list)==4:
            row = Organism.objects.create(taxaId=organism_id, clade=content_list[0], genus=content_list[1], species=content_list[2])           
            row.save()
        else: 
            print('error: populate_db, length is not = 3 for organism_id')

        organism_rows[organism_id]=row
        
                
    print('Done organisms table ')

    return organism_rows
    
def populate_protein_table(organism_rows, proteins):
    protein_rows = {}
    
    for protein_id in proteins:
        content_list = proteins[protein_id]
        row = Protein.objects.create(proteinId=protein_id, sequence=content_list[0], length=content_list[1])
        if content_list[2]:
            organism_id = content_list[2]
            if organism_id in organism_rows:
                row.organism = organism_rows[organism_id]
            else:
                print('no organism');
        
        row.save()
        protein_rows[protein_id] = row
        
    print('Done Protein table ')
    return protein_rows

def populate_domain_table(domain_rows, protein_rows, domains):
   
    for domain_id, domain_list in domains.items():
        row = Domain.objects.create(domainId=domain_id,description=domain_list[0],
                                    protien=protein_rows[domain_list[1]],
                                    )
        
        row.save()
        domain_rows[domain_id] = row
        
    print('Done Domain table ')       
    return domain_rows


def populate_protein_organism(protein_organism, organism_rows, protein_rows):
    #container[protein_id] = [start, end, taxa_id]
    for protein_id, link_list in protein_organism.items():
        # print('protein_organism', org_id, link_list)
        
        protein = protein_rows[protein_id]
        organism = organism_rows[link_list[2]]
        start = link_list[0]
        stop = link_list[1]

        row = ProteinOrganismLink.objects.create(organism=organism, protein=protein, start=start, stop=stop)
        row.save()
    print('Done Protein Organism table ')
        
# delete_all_tables()
# organism_rows = populate_organisms_table(organism_rows, organisms)
# protein_rows = populate_protein_table(organism_rows, proteins)
# domain_rows = populate_domain_table(domain_rows, protein_rows, domains)
# populate_protein_organism(protein_organism, organism_rows, protein_rows)

def add_pfam_sequence():


    with open(data_sequences_file) as csv_file:
        csv_reader_data_sequences = csv.reader(csv_file, delimiter='\n')
        for row in csv_reader_data_sequences:
            #tupple contains 'protein ID' and 'Protein Sequence' 
            tupple = row[0].split(',')
            proteinId = tupple[0]
            sequence = tupple[1]

            try:
                protein = Protein.objects.get(proteinId=proteinId)
                protein.sequence = sequence
                protein.save()

            except Protein.DoesNotExist:
                    print(f"Protein with ID {proteinId} does not exist.")




    with open(pfam_descriptions) as csv_file:
        csv_reader_pfam_descriptions = csv.reader(csv_file, delimiter='\n')
        for row in csv_reader_pfam_descriptions:
            split_list = row[0].split(',')
            #print(split_list)

            domainId=split_list[0]
            domainFamDesc=split_list[1]
            
            pfam = Pfam(domainId=domainId, domainFamDesc=domainFamDesc)
            pfam.save()



# add_pfam_sequence()